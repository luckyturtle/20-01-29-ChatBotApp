var WebRctApp=WebRctApp||{},audio_watting=new Audio("../sound/watting.wav"),audio_ringing=new Audio("../sound/Ringing.wav");WebRctApp.startConnection=function(){var t=WebRtc.ConnectionManager,n,i;return setup=function(){var r=(new signalR.HubConnectionBuilder).withUrl(root+"/WebRtcHub").build();i=r;r.start().then(function(){r.invoke("join",$("#callerName").val()).catch(n=>console.error(n))}).catch(function(){});setupHubCallbacks(r);$(".callUser").click(function(){startWattingSound();r.invoke("callUser",$("#calleeUserName").val()).catch(n=>console.log(n))});$(".hangUp").click(function(){alertify.confirm("Confirm Message","Are you sure, you want to end the call?",function(){stopWattingSound();r.invoke("HangUp",$("#calleeUserName").val()).catch(n=>console.error(n));$("#ptpCall").modal("hide");t.closeAllConnections();n.getTracks().forEach(function(n){n.stop()})},function(){})})},startRingingSound=function(){audio_ringing.loop=!0;audio_ringing.play()},stopRingingSound=function(){audio_ringing.pause();audio_ringing.currentTime=0},startWattingSound=function(){audio_watting.loop=!0;audio_watting.play()},stopWattingSound=function(){audio_watting.pause();audio_watting.currentTime=0},notifyPopup=function(n,t,i){var r,u;try{if(r="",r=i!=null?root+"/Profile/GetUserProfile/"+i.id+" ":root+"/images/default-image.svg ",!Notification){alertify.error("Desktop notifications not available in your browser. Try other browser.");return}Notification.permission!=="granted"?Notification.requestPermission():(u=new Notification(n,{icon:r,body:t}),u.onclick=function(){window.open(root+"/Profile/"+i.username)})}catch(f){}},setupHubCallbacks=function(r){r.on("calleeNotConnected",function(){stopWattingSound();alertify.alert("The User you trying to call is not connected",'Sorry :(  "'+$("#calleeUserName").val()+'" is not connected for now, please call back later')});r.on("callerCanceled",function(n){alertify.error(n+" has hung up.");alertify.closeAll();stopRingingSound()});r.on("receiveSignal",function(n,i){t.newSignal(n.connectionId,i)});r.on("incomingCall",function(u){startRingingSound();alertify.notify("incoming call from: "+u.username,"custom",3,"");notifyPopup("Incoming call",u.username+" is calling. Do you want to chat?",u);alertify.confirm("Incoming call",u.username+" is calling. Do you want to chat?",function(){stopRingingSound();getUserMedia({video:!0,audio:!0},function(r){var f={onReadyForStream:function(t){t.addStream(n)},onStreamAdded:function(n,t){var i=document.querySelector(".video.partner");attachMediaStream(i,t.stream)},onStreamRemoved:function(){var n=document.querySelector(".video.partner");n.src=""}},e;t.initialize(i,f.onReadyForStream,f.onStreamAdded,f.onStreamRemoved);n=r;e=document.querySelector(".video.mine");attachMediaStream(e,n);i.invoke("answerCall",!0,u.connectionId).catch(n=>console.error(n));$("#calleeUserName").val(u.username);$("#ptpCall").modal("show")},function(n){alertify.alert("<h4>Failed to get hardware access!<\/h4> Do you have another browser type open and using your cam/mic?<br/><br/>You were not connected to the server, because I didn't code to make browsers without media access work well. <br/><br/>Actual Error: "+JSON.stringify(n))})},function(){stopRingingSound();r.invoke("answerCall",!1,u.connectionId).catch(n=>console.error(n))})});r.on("callAccepted",function(i){stopWattingSound();alertify.notify("call accepted from: "+i.username,"custom",3,"");t.initiateOffer(i.connectionId,n)});r.on("callDeclined",function(n){stopWattingSound();alertify.error(n)});r.on("callEnded",function(n,i){stopWattingSound();alertify.error(i);t.closeConnection(n)});r.on("receiveSignal",function(n,i){t.newSignal(n.connectionId,i)})},startSession=function(){getUserMedia({video:!0,audio:!0},function(r){var u={onReadyForStream:function(t){t.addStream(n)},onStreamAdded:function(n,t){var i=document.querySelector(".video.partner");attachMediaStream(i,t.stream)},onStreamRemoved:function(){var n=document.querySelector(".video.partner");n.src=""}},f;t.initialize(i,u.onReadyForStream,u.onStreamAdded,u.onStreamRemoved);n=r;f=document.querySelector(".video.mine");attachMediaStream(f,n)},function(n){alertify.alert("<h4>Failed to get hardware access!<\/h4> Do you have another browser type open and using your cam/mic?<br/><br/>You were not connected to the server, because I didn't code to make browsers without media access work well. <br/><br/>Actual Error: "+JSON.stringify(n))})},start=function(){(webrtcDetectedBrowser==undefined||webrtcDetectedBrowser==null)&&alertify.error("Your browser doesnt appear to support WebRTC");startSession()},{start:start,setup:setup}}();