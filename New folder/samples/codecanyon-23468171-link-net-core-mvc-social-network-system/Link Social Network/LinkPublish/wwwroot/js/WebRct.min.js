var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,WebRtc;navigator.mozGetUserMedia?(console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),attachMediaStream=function(n,t){console.log("Attaching media stream");n.mozSrcObject=t;n.play()},reattachMediaStream=function(n,t){console.log("Reattaching media stream");n.mozSrcObject=t.mozSrcObject;n.play()},MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]}):navigator.webkitGetUserMedia?(console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(n,t){try{n.srcObject=t}catch(i){n.src=webkitURL.createObjectURL(t)}},reattachMediaStream=function(n,t){n.src=t.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):console.log("Browser does not appear to be WebRTC-capable");WebRtc=WebRtc||{};WebRtc.ConnectionManager=function(){var t,n={},o=[{url:"stun:74.125.142.127:19302"}],r=function(){console.log("UNIMPLEMENTED: _onReadyForStreamCallback")},u=function(){console.log("UNIMPLEMENTED: _onStreamAddedCallback")},i=function(){console.log("UNIMPLEMENTED: _onStreamRemovedCallback")},s=function(n,f,e,o){t=n;r=f||r;u=e||u;i=o||i},h=function(r){console.log("WebRTC: creating connection...");var f=new RTCPeerConnection({iceServers:o});return f.onicecandidate=function(n){n.candidate?(console.log("WebRTC: new ICE candidate"),t.invoke("sendSignal",JSON.stringify({candidate:n.candidate}),r).catch(n=>console.error(n))):console.log("WebRTC: ICE candidate gathering complete")},f.onstatechange=function(){var n={iceConnectionState:f.iceConnectionState,iceGatheringState:f.iceGatheringState,readyState:f.readyState,signalingState:f.signalingState};console.log(JSON.stringify(n))},f.onaddstream=function(n){console.log("WebRTC: adding stream");u(f,n)},f.onremovestream=function(n){console.log("WebRTC: removing stream");i(f,n.stream.id)},n[r]=f,f},c=function(n,i,u){console.log("WebRTC: processing sdp signal");n.setRemoteDescription(new RTCSessionDescription(u),function(){n.remoteDescription.type=="offer"?(console.log("WebRTC: received offer, sending response..."),r(n),n.createAnswer(function(r){n.setLocalDescription(r,function(){t.invoke("sendSignal",JSON.stringify({sdp:n.localDescription}),i).catch(n=>console.error(n))})},function(n){console.log("Error creating session description: "+n)})):n.remoteDescription.type=="answer"&&console.log("WebRTC: received answer")})},l=function(n,t){var i=JSON.parse(t),r=f(n);console.log("WebRTC: received signal");i.sdp?c(r,n,i.sdp):i.candidate&&a(r,n,i.candidate)},a=function(n,t,i){console.log("WebRTC: processing candidate signal");n.addIceCandidate(new RTCIceCandidate(i))},f=function(t){return n[t]||h(t)},v=function(){for(var t in n)e(t)},e=function(t){var r=n[t];r&&(i(null,null),r.close(),delete n[t])},y=function(n,i){var r=f(n);r.addStream(i);console.log("stream added on my end");r.createOffer(function(i){r.setLocalDescription(i,function(){t.invoke("sendSignal",JSON.stringify({sdp:r.localDescription}),n).catch(n=>console.error(n))})},function(n){console.log("Error creating session description: "+n)})};return{initialize:s,newSignal:l,closeConnection:e,closeAllConnections:v,initiateOffer:y}}();var WebRctApp=WebRctApp||{},audio_watting=new Audio("../sound/watting.wav"),audio_ringing=new Audio("../sound/Ringing.wav");WebRctApp.startConnection=function(){var t=WebRtc.ConnectionManager,n,i;return setup=function(){var r=(new signalR.HubConnectionBuilder).withUrl(root+"/WebRtcHub").build();i=r;r.start().then(function(){r.invoke("join",$("#callerName").val()).catch(n=>console.error(n))}).catch(function(){});setupHubCallbacks(r);$(".callUser").click(function(){startWattingSound();r.invoke("callUser",$("#calleeUserName").val()).catch(n=>console.log(n))});$(".hangUp").click(function(){alertify.confirm("Confirm Message","Are you sure, you want to end the call?",function(){stopWattingSound();r.invoke("HangUp",$("#calleeUserName").val()).catch(n=>console.error(n));$("#ptpCall").modal("hide");t.closeAllConnections();n.getTracks().forEach(function(n){n.stop()})},function(){})})},startRingingSound=function(){audio_ringing.loop=!0;audio_ringing.play()},stopRingingSound=function(){audio_ringing.pause();audio_ringing.currentTime=0},startWattingSound=function(){audio_watting.loop=!0;audio_watting.play()},stopWattingSound=function(){audio_watting.pause();audio_watting.currentTime=0},notifyPopup=function(n,t,i){var r,u;try{if(r="",r=i!=null?root+"/Profile/GetUserProfile/"+i.id+" ":root+"/images/default-image.svg ",!Notification){alertify.error("Desktop notifications not available in your browser. Try other browser.");return}Notification.permission!=="granted"?Notification.requestPermission():(u=new Notification(n,{icon:r,body:t}),u.onclick=function(){window.open(root+"/Profile/"+i.username)})}catch(f){}},setupHubCallbacks=function(r){r.on("calleeNotConnected",function(){stopWattingSound();alertify.alert("The User you trying to call is not connected",'Sorry :(  "'+$("#calleeUserName").val()+'" is not connected for now, please call back later')});r.on("callerCanceled",function(n){alertify.error(n+" has hung up.");alertify.closeAll();stopRingingSound()});r.on("receiveSignal",function(n,i){t.newSignal(n.connectionId,i)});r.on("incomingCall",function(u){startRingingSound();alertify.notify("incoming call from: "+u.username,"custom",3,"");notifyPopup("Incoming call",u.username+" is calling. Do you want to chat?",u);alertify.confirm("Incoming call",u.username+" is calling. Do you want to chat?",function(){stopRingingSound();getUserMedia({video:!0,audio:!0},function(r){var f={onReadyForStream:function(t){t.addStream(n)},onStreamAdded:function(n,t){var i=document.querySelector(".video.partner");attachMediaStream(i,t.stream)},onStreamRemoved:function(){var n=document.querySelector(".video.partner");n.src=""}},e;t.initialize(i,f.onReadyForStream,f.onStreamAdded,f.onStreamRemoved);n=r;e=document.querySelector(".video.mine");attachMediaStream(e,n);i.invoke("answerCall",!0,u.connectionId).catch(n=>console.error(n));$("#calleeUserName").val(u.username);$("#ptpCall").modal("show")},function(n){alertify.alert("<h4>Failed to get hardware access!<\/h4> Do you have another browser type open and using your cam/mic?<br/><br/>You were not connected to the server, because I didn't code to make browsers without media access work well. <br/><br/>Actual Error: "+JSON.stringify(n))})},function(){stopRingingSound();r.invoke("answerCall",!1,u.connectionId).catch(n=>console.error(n))})});r.on("callAccepted",function(i){stopWattingSound();alertify.notify("call accepted from: "+i.username,"custom",3,"");t.initiateOffer(i.connectionId,n)});r.on("callDeclined",function(n){stopWattingSound();alertify.error(n)});r.on("callEnded",function(n,i){stopWattingSound();alertify.error(i);t.closeConnection(n)});r.on("receiveSignal",function(n,i){t.newSignal(n.connectionId,i)})},startSession=function(){getUserMedia({video:!0,audio:!0},function(r){var u={onReadyForStream:function(t){t.addStream(n)},onStreamAdded:function(n,t){var i=document.querySelector(".video.partner");attachMediaStream(i,t.stream)},onStreamRemoved:function(){var n=document.querySelector(".video.partner");n.src=""}},f;t.initialize(i,u.onReadyForStream,u.onStreamAdded,u.onStreamRemoved);n=r;f=document.querySelector(".video.mine");attachMediaStream(f,n)},function(n){alertify.alert("<h4>Failed to get hardware access!<\/h4> Do you have another browser type open and using your cam/mic?<br/><br/>You were not connected to the server, because I didn't code to make browsers without media access work well. <br/><br/>Actual Error: "+JSON.stringify(n))})},start=function(){(webrtcDetectedBrowser==undefined||webrtcDetectedBrowser==null)&&alertify.error("Your browser doesnt appear to support WebRTC");startSession()},{start:start,setup:setup}}();