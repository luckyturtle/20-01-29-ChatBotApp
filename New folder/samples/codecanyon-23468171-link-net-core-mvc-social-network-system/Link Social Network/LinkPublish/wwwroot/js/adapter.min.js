"use strict";function trace(n){if(n[n.length-1]==="\n"&&(n=n.substring(0,n.length-1)),window.performance){var t=(window.performance.now()/1e3).toFixed(3);webrtcUtils.log(t+": "+n)}else webrtcUtils.log(n)}function requestUserMedia(n){return new Promise(function(t,i){getUserMedia(n,t,i)})}var getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null,webrtcMinimumVersion=null,webrtcUtils={log:function(){typeof module=="undefined"&&(typeof require!="function"||typeof define!="function")&&console.log.apply(console,arguments)},extractVersion:function(n,t,i){var r=n.match(t);return r&&r.length>=i&&parseInt(r[i],10)}},orgEnumerateDevices,constraintsToChrome,origGetUserMedia,webrtcTesting,RTCPeerConnection,RTCIceCandidate,RTCSessionDescription;if(typeof window=="object"&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return"mozSrcObject"in this?this.mozSrcObject:this._srcObject},set:function(n){"mozSrcObject"in this?this.mozSrcObject=n:(this._srcObject=n,this.src=URL.createObjectURL(n))}}),getUserMedia=window.navigator&&window.navigator.getUserMedia),attachMediaStream=function(n,t){n.srcObject=t},reattachMediaStream=function(n,t){n.srcObject=t.srcObject},typeof window!="undefined"&&window.navigator)if(navigator.mozGetUserMedia&&window.mozRTCPeerConnection)webrtcUtils.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=webrtcUtils.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1),webrtcMinimumVersion=31,window.RTCPeerConnection=function(n,t){var f,r,i,u,e;if(webrtcDetectedVersion<38&&n&&n.iceServers){for(f=[],r=0;r<n.iceServers.length;r++)if(i=n.iceServers[r],i.hasOwnProperty("urls"))for(u=0;u<i.urls.length;u++)e={url:i.urls[u]},i.urls[u].indexOf("turn")===0&&(e.username=i.username,e.credential=i.credential),f.push(e);else f.push(n.iceServers[r]);n.iceServers=f}return new mozRTCPeerConnection(n,t)},mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return arguments.length?mozRTCPeerConnection.generateCertificate.apply(null,arguments):mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription||(window.RTCSessionDescription=mozRTCSessionDescription),window.RTCIceCandidate||(window.RTCIceCandidate=mozRTCIceCandidate),getUserMedia=function(n,t,i){var r=function(n){if(typeof n!="object"||n.require)return n;var t=[];return Object.keys(n).forEach(function(i){var r,u;i!=="require"&&i!=="advanced"&&i!=="mediaSource"&&(r=n[i]=typeof n[i]=="object"?n[i]:{ideal:n[i]},(r.min!==undefined||r.max!==undefined||r.exact!==undefined)&&t.push(i),r.exact!==undefined&&(typeof r.exact=="number"?r.min=r.max=r.exact:n[i]=r.exact,delete r.exact),r.ideal!==undefined&&(n.advanced=n.advanced||[],u={},u[i]=typeof r.ideal=="number"?{min:r.ideal,max:r.ideal}:r.ideal,n.advanced.push(u),delete r.ideal,Object.keys(r).length||delete n[i]))}),t.length&&(n.require=t),n};return webrtcDetectedVersion<38&&(webrtcUtils.log("spec: "+JSON.stringify(n)),n.audio&&(n.audio=r(n.audio)),n.video&&(n.video=r(n.video)),webrtcUtils.log("ff37: "+JSON.stringify(n))),navigator.mozGetUserMedia(n,t,i)},navigator.getUserMedia=getUserMedia,navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:requestUserMedia,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(n){n([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])})},webrtcDetectedVersion<41&&(orgEnumerateDevices=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices),navigator.mediaDevices.enumerateDevices=function(){return orgEnumerateDevices().then(undefined,function(n){if(n.name==="NotFoundError")return[];throw n;})});else if(navigator.webkitGetUserMedia&&window.webkitRTCPeerConnection)webrtcUtils.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",webrtcDetectedVersion=webrtcUtils.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2),webrtcMinimumVersion=38,window.RTCPeerConnection=function(n,t){n&&n.iceTransportPolicy&&(n.iceTransports=n.iceTransportPolicy);var i=new webkitRTCPeerConnection(n,t),r=i.getStats.bind(i);return i.getStats=function(n,t){var u=this,f=arguments,i,e;return arguments.length>0&&typeof n=="function"?r(n,t):(i=function(n){var t={},i=n.result();return i.forEach(function(n){var i={id:n.id,timestamp:n.timestamp,type:n.type};n.names().forEach(function(t){i[t]=n.stat(t)});t[i.id]=i}),t},arguments.length>=2)?(e=function(n){f[1](i(n))},r.apply(this,[e,arguments[0]])):new Promise(function(t,e){f.length===1&&n===null?r.apply(u,[function(n){t.apply(null,[i(n)])},e]):r.apply(u,[t,e])})},i},webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return arguments.length?webkitRTCPeerConnection.generateCertificate.apply(null,arguments):webkitRTCPeerConnection.generateCertificate}}),["createOffer","createAnswer"].forEach(function(n){var t=webkitRTCPeerConnection.prototype[n];webkitRTCPeerConnection.prototype[n]=function(){var i=this,n;return arguments.length<1||arguments.length===1&&typeof arguments[0]=="object"?(n=arguments.length===1?arguments[0]:undefined,new Promise(function(r,u){t.apply(i,[r,u,n])})):t.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){var t=webkitRTCPeerConnection.prototype[n];webkitRTCPeerConnection.prototype[n]=function(){var n=arguments,i=this;return new Promise(function(r,u){t.apply(i,[n[0],function(){r();n.length>=2&&n[1].apply(null,[])},function(t){u(t);n.length>=3&&n[2].apply(null,[t])}])})}}),constraintsToChrome=function(n){if(typeof n!="object"||n.mandatory||n.optional)return n;var t={};return Object.keys(n).forEach(function(i){var r,f,u;i!=="require"&&i!=="advanced"&&i!=="mediaSource"&&(r=typeof n[i]=="object"?n[i]:{ideal:n[i]},r.exact!==undefined&&typeof r.exact=="number"&&(r.min=r.max=r.exact),f=function(n,t){return n?n+t.charAt(0).toUpperCase()+t.slice(1):t==="deviceId"?"sourceId":t},r.ideal!==undefined&&(t.optional=t.optional||[],u={},typeof r.ideal=="number"?(u[f("min",i)]=r.ideal,t.optional.push(u),u={},u[f("max",i)]=r.ideal,t.optional.push(u)):(u[f("",i)]=r.ideal,t.optional.push(u))),r.exact!==undefined&&typeof r.exact!="number"?(t.mandatory=t.mandatory||{},t.mandatory[f("",i)]=r.exact):["min","max"].forEach(function(n){r[n]!==undefined&&(t.mandatory=t.mandatory||{},t.mandatory[f(n,i)]=r[n])}))}),n.advanced&&(t.optional=(t.optional||[]).concat(n.advanced)),t},getUserMedia=function(n,t,i){return n.audio&&(n.audio=constraintsToChrome(n.audio)),n.video&&(n.video=constraintsToChrome(n.video)),webrtcUtils.log("chrome: "+JSON.stringify(n)),navigator.webkitGetUserMedia(n,t,i)},navigator.getUserMedia=getUserMedia,navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:requestUserMedia,enumerateDevices:function(){return new Promise(function(n){var t={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(i){n(i.map(function(n){return{label:n.label,kind:t[n.kind],deviceId:n.id,groupId:""}}))})})}}),navigator.mediaDevices.getUserMedia?(origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices),navigator.mediaDevices.getUserMedia=function(n){return webrtcUtils.log("spec:   "+JSON.stringify(n)),n.audio=constraintsToChrome(n.audio),n.video=constraintsToChrome(n.video),webrtcUtils.log("chrome: "+JSON.stringify(n)),origGetUserMedia(n)}):navigator.mediaDevices.getUserMedia=function(n){return requestUserMedia(n)},typeof navigator.mediaDevices.addEventListener=="undefined"&&(navigator.mediaDevices.addEventListener=function(){webrtcUtils.log("Dummy mediaDevices.addEventListener called.")}),typeof navigator.mediaDevices.removeEventListener=="undefined"&&(navigator.mediaDevices.removeEventListener=function(){webrtcUtils.log("Dummy mediaDevices.removeEventListener called.")}),attachMediaStream=function(n,t){webrtcDetectedVersion>=43?n.srcObject=t:typeof n.src!="undefined"?n.src=URL.createObjectURL(t):webrtcUtils.log("Error attaching stream to element.")},reattachMediaStream=function(n,t){webrtcDetectedVersion>=43?n.srcObject=t.srcObject:n.src=t.src};else if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)){if(webrtcUtils.log("This appears to be Edge"),webrtcDetectedBrowser="edge",webrtcDetectedVersion=webrtcUtils.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2),webrtcMinimumVersion=10547,RTCIceGatherer){var generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},localCName=generateIdentifier(),SDPUtils={};SDPUtils.splitLines=function(n){return n.trim().split("\n").map(function(n){return n.trim()})};SDPUtils.splitSections=function(n){var t=n.split("\r\nm=");return t.map(function(n,t){return(t>0?"m="+n:n).trim()+"\r\n"})};SDPUtils.matchPrefix=function(n,t){return SDPUtils.splitLines(n).filter(function(n){return n.indexOf(t)===0})};SDPUtils.parseCandidate=function(n){var t,r,i;for(t=n.indexOf("a=candidate:")===0?n.substring(12).split(" "):n.substring(10).split(" "),r={foundation:t[0],component:t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)switch(t[i]){case"raddr":r.relatedAddress=t[i+1];break;case"rport":r.relatedPort=parseInt(t[i+1],10);break;case"tcptype":r.tcpType=t[i+1]}return r};SDPUtils.writeCandidate=function(n){var t=[],i;return t.push(n.foundation),t.push(n.component),t.push(n.protocol.toUpperCase()),t.push(n.priority),t.push(n.ip),t.push(n.port),i=n.type,t.push("typ"),t.push(i),i!=="host"&&n.relatedAddress&&n.relatedPort&&(t.push("raddr"),t.push(n.relatedAddress),t.push("rport"),t.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(t.push("tcptype"),t.push(n.tcpType)),"candidate:"+t.join(" ")};SDPUtils.parseRtpMap=function(n){var t=n.substr(9).split(" "),i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.numChannels=t.length===3?parseInt(t[2],10):1,i};SDPUtils.writeRtpMap=function(n){var t=n.payloadType;return n.preferredPayloadType!==undefined&&(t=n.preferredPayloadType),"a=rtpmap:"+t+" "+n.name+"/"+n.clockRate+(n.numChannels!==1?"/"+n.numChannels:"")+"\r\n"};SDPUtils.parseFmtp=function(n){for(var r={},t,u=n.substr(n.indexOf(" ")+1).split(";"),i=0;i<u.length;i++)t=u[i].trim().split("="),r[t[0].trim()]=t[1];return r};SDPUtils.writeFtmp=function(n){var i="",r=n.payloadType,t;return n.preferredPayloadType!==undefined&&(r=n.preferredPayloadType),n.parameters&&n.parameters.length&&(t=[],Object.keys(n.parameters).forEach(function(i){t.push(i+"="+n.parameters[i])}),i+="a=fmtp:"+r+" "+t.join(";")+"\r\n"),i};SDPUtils.parseRtcpFb=function(n){var t=n.substr(n.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}};SDPUtils.writeRtcpFb=function(n){var t="",i=n.payloadType;return n.preferredPayloadType!==undefined&&(i=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach(function(n){t+="a=rtcp-fb:"+i+" "+n.type+" "+n.parameter+"\r\n"}),t};SDPUtils.parseSsrcMedia=function(n){var t=n.indexOf(" "),i={ssrc:n.substr(7,t-7)},r=n.indexOf(":",t);return r>-1?(i.attribute=n.substr(t+1,r-t-1),i.value=n.substr(r+1)):i.attribute=n.substr(t+1),i};SDPUtils.getDtlsParameters=function(n,t){var i=SDPUtils.splitLines(n),r,u;return i=i.concat(SDPUtils.splitLines(t)),r=i.filter(function(n){return n.indexOf("a=fingerprint:")===0})[0].substr(14),u={role:"auto",fingerprints:[{algorithm:r.split(" ")[0],value:r.split(" ")[1]}]},u};SDPUtils.writeDtlsParameters=function(n,t){var i="a=setup:"+t+"\r\n";return n.fingerprints.forEach(function(n){i+="a=fingerprint:"+n.algorithm+" "+n.value+"\r\n"}),i};SDPUtils.getIceParameters=function(n,t){var i=SDPUtils.splitLines(n);return i=i.concat(SDPUtils.splitLines(t)),{usernameFragment:i.filter(function(n){return n.indexOf("a=ice-ufrag:")===0})[0].substr(12),password:i.filter(function(n){return n.indexOf("a=ice-pwd:")===0})[0].substr(10)}};SDPUtils.writeIceParameters=function(n){return"a=ice-ufrag:"+n.usernameFragment+"\r\na=ice-pwd:"+n.password+"\r\n"};SDPUtils.parseRtpParameters=function(n){for(var t,u,i,f,e={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},s=SDPUtils.splitLines(n),o=s[0].split(" "),r=3;r<o.length;r++)t=o[r],u=SDPUtils.matchPrefix(n,"a=rtpmap:"+t+" ")[0],u&&(i=SDPUtils.parseRtpMap(u),f=SDPUtils.matchPrefix(n,"a=fmtp:"+t+" "),i.parameters=f.length?SDPUtils.parseFmtp(f[0]):{},i.rtcpFeedback=SDPUtils.matchPrefix(n,"a=rtcp-fb:"+t+" ").map(SDPUtils.parseRtcpFb),e.codecs.push(i));return e};SDPUtils.writeRtpDescription=function(n,t){var i="";return i+="m="+n+" ",i+=t.codecs.length>0?"9":"0",i+=" UDP/TLS/RTP/SAVPF ",i+=t.codecs.map(function(n){return n.preferredPayloadType!==undefined?n.preferredPayloadType:n.payloadType}).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(n){i+=SDPUtils.writeRtpMap(n);i+=SDPUtils.writeFtmp(n);i+=SDPUtils.writeRtcpFb(n)}),i+="a=rtcp-mux\r\n"};SDPUtils.writeSessionBoilerplate=function(){return"v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"};SDPUtils.writeMediaSection=function(n,t,i,r){var u=SDPUtils.writeRtpDescription(n.kind,t),f;return u+=SDPUtils.writeIceParameters(n.iceGatherer.getLocalParameters()),u+=SDPUtils.writeDtlsParameters(n.dtlsTransport.getLocalParameters(),i==="offer"?"actpass":"active"),u+="a=mid:"+n.mid+"\r\n",u+=n.rtpSender&&n.rtpReceiver?"a=sendrecv\r\n":n.rtpSender?"a=sendonly\r\n":n.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",n.rtpSender&&(f="msid:"+r.id+" "+n.rtpSender.track.id+"\r\n",u+="a="+f,u+="a=ssrc:"+n.sendSsrc+" "+f),u+("a=ssrc:"+n.sendSsrc+" cname:"+localCName+"\r\n")};SDPUtils.getDirection=function(n,t){for(var r=SDPUtils.splitLines(n),i=0;i<r.length;i++)switch(r[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[i].substr(2)}return t?SDPUtils.getDirection(t):"sendrecv"};window.RTCIceCandidate||(window.RTCIceCandidate=function(n){return n});window.RTCSessionDescription||(window.RTCSessionDescription=function(n){return n});window.RTCPeerConnection=function(n){var t=this;if(this.onicecandidate=null,this.onaddstream=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return t.localStreams},this.getRemoteStreams=function(){return t.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},n&&n.iceTransportPolicy)switch(n.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=n.iceTransportPolicy;break;case"none":throw new TypeError('iceTransportPolicy "none" not supported');}n&&n.iceServers&&n.iceServers.forEach(function(n){if(n.urls){var i;i=typeof n.urls=="string"?n.urls:n.urls[0];i.indexOf("transport=udp")!==-1&&t.iceServers.push({username:n.username,credential:n.credential,urls:i})}});this.transceivers=[];this._localIceCandidatesBuffer=[]};window.RTCPeerConnection.prototype._emitBufferedCandidates=function(){var n=this;this._localIceCandidatesBuffer.forEach(function(t){if(n.onicecandidate!==null)n.onicecandidate(t)});this._localIceCandidatesBuffer=[]};window.RTCPeerConnection.prototype.addStream=function(n){this.localStreams.push(n.clone());this._maybeFireNegotiationNeeded()};window.RTCPeerConnection.prototype.removeStream=function(n){var t=this.localStreams.indexOf(n);t>-1&&(this.localStreams.splice(t,1),this._maybeFireNegotiationNeeded())};window.RTCPeerConnection.prototype._getCommonCapabilities=function(n,t){var i={codecs:[],headerExtensions:[],fecMechanisms:[]};return n.codecs.forEach(function(n){for(var r,u=0;u<t.codecs.length;u++)if(r=t.codecs[u],n.name.toLowerCase()===r.name.toLowerCase()&&n.clockRate===r.clockRate&&n.numChannels===r.numChannels){i.codecs.push(r);break}}),n.headerExtensions.forEach(function(n){for(var u,r=0;r<t.headerExtensions.length;r++)if(u=t.headerExtensions[r],n.uri===u.uri){i.headerExtensions.push(u);break}}),i};window.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(n,t){var i=this,r=new RTCIceGatherer(i.iceOptions),f=new RTCIceTransport(r),u;return r.onlocalcandidate=function(u){var e={},o,s;if(e.candidate={sdpMid:n,sdpMLineIndex:t},o=u.candidate,o&&Object.keys(o).length!==0?(o.component=f.component==="RTCP"?2:1,e.candidate.candidate=SDPUtils.writeCandidate(o)):(r.state===undefined&&(r.state="completed"),e.candidate.candidate="candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates"),s=i.transceivers.every(function(n){return n.iceGatherer&&n.iceGatherer.state==="completed"}),i.onicecandidate!==null)if(i.localDescription&&i.localDescription.type==="")i._localIceCandidatesBuffer.push(e),s&&i._localIceCandidatesBuffer.push({});else{i.onicecandidate(e);if(s)i.onicecandidate({})}},f.onicestatechange=function(){i._updateConnectionState()},u=new RTCDtlsTransport(f),u.ondtlsstatechange=function(){i._updateConnectionState()},u.onerror=function(){u.state="failed";i._updateConnectionState()},{iceGatherer:r,iceTransport:f,dtlsTransport:u}};window.RTCPeerConnection.prototype._transceive=function(n,t,i){var r=this._getCommonCapabilities(n.localCapabilities,n.remoteCapabilities);t&&n.rtpSender&&(r.encodings=[{ssrc:n.sendSsrc}],r.rtcp={cname:localCName,ssrc:n.recvSsrc},n.rtpSender.send(r));i&&n.rtpReceiver&&(r.encodings=[{ssrc:n.recvSsrc}],r.rtcp={cname:n.cname,ssrc:n.sendSsrc},n.rtpReceiver.receive(r))};window.RTCPeerConnection.prototype.setLocalDescription=function(n){var t=this,i,r,u,e,f;n.type==="offer"?this._pendingOffer&&(this.transceivers=this._pendingOffer,delete this._pendingOffer):n.type==="answer"&&(i=SDPUtils.splitSections(t.remoteDescription.sdp),r=i.shift(),i.forEach(function(n,i){var u=t.transceivers[i],s=u.iceGatherer,h=u.iceTransport,c=u.dtlsTransport,l=u.localCapabilities,a=u.remoteCapabilities,v=n.split("\n",1)[0].split(" ",2)[1]==="0",f,e,o;v||(f=SDPUtils.getIceParameters(n,r),h.start(s,f,"controlled"),e=SDPUtils.getDtlsParameters(n,r),c.start(e),o=t._getCommonCapabilities(l,a),t._transceive(u,o.codecs.length>0,!1))}));this.localDescription=n;switch(n.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+n.type+'"');}return u=arguments.length>1&&typeof arguments[1]=="function",u&&(e=arguments[1],window.setTimeout(function(){e();t._emitBufferedCandidates()},0)),f=Promise.resolve(),f.then(function(){u||window.setTimeout(t._emitBufferedCandidates.bind(t),0)}),f};window.RTCPeerConnection.prototype.setRemoteDescription=function(n){var t=this,i=new MediaStream,u=SDPUtils.splitSections(n.sdp),r=u.shift();u.forEach(function(u,f){var et=SDPUtils.splitLines(u),k=et[0].substr(2).split(" "),l=k[0],d=k[1]==="0",o=SDPUtils.getDirection(u,r),e,g,nt,tt,a,s,v,y,p,it=SDPUtils.parseRtpParameters(u),rt,ut,w,b,c,h,ft;d||(rt=SDPUtils.getIceParameters(u,r),ut=SDPUtils.getDtlsParameters(u,r));w=SDPUtils.matchPrefix(u,"a=mid:")[0].substr(6);c=SDPUtils.matchPrefix(u,"a=ssrc:").map(function(n){return SDPUtils.parseSsrcMedia(n)}).filter(function(n){return n.attribute==="cname"})[0];c&&(y=parseInt(c.ssrc,10),b=c.value);n.type==="offer"?(h=t._createIceAndDtlsTransports(w,f),p=RTCRtpReceiver.getCapabilities(l),v=(2*f+2)*1001,s=new RTCRtpReceiver(h.dtlsTransport,l),i.addTrack(s.track),t.localStreams.length>0&&t.localStreams[0].getTracks().length>=f&&(ft=t.localStreams[0].getTracks()[f],a=new RTCRtpSender(ft,h.dtlsTransport)),t.transceivers[f]={iceGatherer:h.iceGatherer,iceTransport:h.iceTransport,dtlsTransport:h.dtlsTransport,localCapabilities:p,remoteCapabilities:it,rtpSender:a,rtpReceiver:s,kind:l,mid:w,cname:b,sendSsrc:v,recvSsrc:y},t._transceive(t.transceivers[f],!1,o==="sendrecv"||o==="sendonly")):n.type!=="answer"||d||(e=t.transceivers[f],g=e.iceGatherer,nt=e.iceTransport,tt=e.dtlsTransport,a=e.rtpSender,s=e.rtpReceiver,v=e.sendSsrc,p=e.localCapabilities,t.transceivers[f].recvSsrc=y,t.transceivers[f].remoteCapabilities=it,t.transceivers[f].cname=b,nt.start(g,rt,"controlling"),tt.start(ut),t._transceive(e,o==="sendrecv"||o==="recvonly",o==="sendrecv"||o==="sendonly"),s&&(o==="sendrecv"||o==="sendonly")?i.addTrack(s.track):delete e.rtpReceiver)});this.remoteDescription=n;switch(n.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+n.type+'"');}return window.setTimeout(function(){t.onaddstream!==null&&i.getTracks().length&&(t.remoteStreams.push(i),window.setTimeout(function(){t.onaddstream({stream:i})},0))},0),arguments.length>1&&typeof arguments[1]=="function"&&window.setTimeout(arguments[1],0),Promise.resolve()};window.RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(n){n.iceTransport&&n.iceTransport.stop();n.dtlsTransport&&n.dtlsTransport.stop();n.rtpSender&&n.rtpSender.stop();n.rtpReceiver&&n.rtpReceiver.stop()});this._updateSignalingState("closed")};window.RTCPeerConnection.prototype._updateSignalingState=function(n){this.signalingState=n;this.onsignalingstatechange!==null&&this.onsignalingstatechange()};window.RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){this.onnegotiationneeded!==null&&this.onnegotiationneeded()};window.RTCPeerConnection.prototype._updateConnectionState=function(){var i=this,t,n={"new":0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};this.transceivers.forEach(function(t){n[t.iceTransport.state]++;n[t.dtlsTransport.state]++});n.connected+=n.completed;t="new";n.failed>0?t="failed":n.connecting>0||n.checking>0?t="connecting":n.disconnected>0?t="disconnected":n.new>0?t="new":(n.connecting>0||n.completed>0)&&(t="connected");t!==i.iceConnectionState&&(i.iceConnectionState=t,this.oniceconnectionstatechange!==null&&this.oniceconnectionstatechange())};window.RTCPeerConnection.prototype.createOffer=function(){var o=this,n,f,u,e;if(this._pendingOffer)throw new Error("createOffer called while there is a pending offer.");arguments.length===1&&typeof arguments[0]!="function"?n=arguments[0]:arguments.length===3&&(n=arguments[2]);var r=[],t=0,i=0;if(this.localStreams.length&&(t=this.localStreams[0].getAudioTracks().length,i=this.localStreams[0].getVideoTracks().length),n){if(n.mandatory||n.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");n.offerToReceiveAudio!==undefined&&(t=n.offerToReceiveAudio);n.offerToReceiveVideo!==undefined&&(i=n.offerToReceiveVideo)}for(this.localStreams.length&&this.localStreams[0].getTracks().forEach(function(n){r.push({kind:n.kind,track:n,wantReceive:n.kind==="audio"?t>0:i>0});n.kind==="audio"?t--:n.kind==="video"&&i--});t>0||i>0;)t>0&&(r.push({kind:"audio",wantReceive:!0}),t--),i>0&&(r.push({kind:"video",wantReceive:!0}),i--);return f=SDPUtils.writeSessionBoilerplate(),u=[],r.forEach(function(n,t){var s=n.track,r=n.kind,h=generateIdentifier(),i=o._createIceAndDtlsTransports(h,t),a=RTCRtpSender.getCapabilities(r),c,l,v=(2*t+1)*1001,e;s&&(c=new RTCRtpSender(s,i.dtlsTransport));n.wantReceive&&(l=new RTCRtpReceiver(i.dtlsTransport,r));u[t]={iceGatherer:i.iceGatherer,iceTransport:i.iceTransport,dtlsTransport:i.dtlsTransport,localCapabilities:a,remoteCapabilities:null,rtpSender:c,rtpReceiver:l,kind:r,mid:h,sendSsrc:v,recvSsrc:null};e=u[t];f+=SDPUtils.writeMediaSection(e,e.localCapabilities,"offer",o.localStreams[0])}),this._pendingOffer=u,e=new RTCSessionDescription({type:"offer",sdp:f}),arguments.length&&typeof arguments[0]=="function"&&window.setTimeout(arguments[0],0,e),Promise.resolve(e)};window.RTCPeerConnection.prototype.createAnswer=function(){var i=this,r,n,t;return arguments.length===1&&typeof arguments[0]!="function"?r=arguments[0]:arguments.length===3&&(r=arguments[2]),n=SDPUtils.writeSessionBoilerplate(),this.transceivers.forEach(function(t){var r=i._getCommonCapabilities(t.localCapabilities,t.remoteCapabilities);n+=SDPUtils.writeMediaSection(t,r,"answer",i.localStreams[0])}),t=new RTCSessionDescription({type:"answer",sdp:n}),arguments.length&&typeof arguments[0]=="function"&&window.setTimeout(arguments[0],0,t),Promise.resolve(t)};window.RTCPeerConnection.prototype.addIceCandidate=function(n){var u=n.sdpMLineIndex,i,r,t;if(n.sdpMid)for(i=0;i<this.transceivers.length;i++)if(this.transceivers[i].mid===n.sdpMid){u=i;break}if(r=this.transceivers[u],r){if(t=Object.keys(n.candidate).length>0?SDPUtils.parseCandidate(n.candidate):{},t.protocol==="tcp"&&t.port===0)return;if(t.component!=="1")return;t.type==="endOfCandidates"&&(t={});r.iceTransport.addRemoteCandidate(t)}return arguments.length>1&&typeof arguments[1]=="function"&&window.setTimeout(arguments[1],0),Promise.resolve()};window.RTCPeerConnection.prototype.getStats=function(){var t=[],n;return this.transceivers.forEach(function(n){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(i){n[i]&&t.push(n[i].getStats())})}),n=arguments.length>1&&typeof arguments[1]=="function"&&arguments[1],new Promise(function(i){var r={};Promise.all(t).then(function(t){t.forEach(function(n){Object.keys(n).forEach(function(t){r[t]=n[t]})});n&&window.setTimeout(n,0,r);i(r)})})}}}else webrtcUtils.log("Browser does not appear to be WebRTC-capable");else webrtcUtils.log("This does not appear to be a browser"),webrtcDetectedBrowser="not a browser";webrtcTesting={};try{Object.defineProperty(webrtcTesting,"version",{set:function(n){webrtcDetectedVersion=n}})}catch(e){}typeof module!="undefined"?(typeof window!="undefined"&&(RTCPeerConnection=window.RTCPeerConnection,RTCIceCandidate=window.RTCIceCandidate,RTCSessionDescription=window.RTCSessionDescription),module.exports={RTCPeerConnection:RTCPeerConnection,RTCIceCandidate:RTCIceCandidate,RTCSessionDescription:RTCSessionDescription,getUserMedia:getUserMedia,attachMediaStream:attachMediaStream,reattachMediaStream:reattachMediaStream,webrtcDetectedBrowser:webrtcDetectedBrowser,webrtcDetectedVersion:webrtcDetectedVersion,webrtcMinimumVersion:webrtcMinimumVersion,webrtcTesting:webrtcTesting,webrtcUtils:webrtcUtils}):typeof require=="function"&&typeof define=="function"&&define([],function(){return{RTCPeerConnection:window.RTCPeerConnection,RTCIceCandidate:window.RTCIceCandidate,RTCSessionDescription:window.RTCSessionDescription,getUserMedia:getUserMedia,attachMediaStream:attachMediaStream,reattachMediaStream:reattachMediaStream,webrtcDetectedBrowser:webrtcDetectedBrowser,webrtcDetectedVersion:webrtcDetectedVersion,webrtcMinimumVersion:webrtcMinimumVersion,webrtcTesting:webrtcTesting,webrtcUtils:webrtcUtils}});